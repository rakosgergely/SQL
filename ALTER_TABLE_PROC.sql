

CREATE TABLE actebis_jde_dynamic.MODIIES_TABLES
(
		TABLES_NAMES VARCHAR(600),
		_ROW_NO_ 	BIGINT AUTO_INCREMENT PRIMARY KEY
);


 INSERT INTO actebis_jde_dynamic.MODIIES_TABLES(TABLES_NAMES)
SELECT column1 from actebis_jde_dynamic.`also_oneworld_tables_problem (1)`;


'prodaddta_f03b112',
'histaddta_f5701309',
'prodaddta_f03b13z1',
'prodaddta_f03b15',
'prodaddta_f03b20',
'prodaddta_f03b21',
'prodaddta_f03b25',
'prodaddta_f03b31',
'prodaddta_f03b571',
'prodaddta_f03b11',
'prodaddta_f03b57ow',
'prodaddta_f0401',
'prodaddta_f03b575',
'prodaddta_f0411a',
'prodaddta_f0411z1',
'prodaddta_f0411',
'prodaddta_f0413',
'prodaddta_f0413z1',
'prodaddta_f0414',
'prodaddta_f0414z1',
'prodaddta_f04257w2',
'prodaddta_f045143',
'prodaddta_f0457',
'prodaddta_f05004',
'prodaddta_f069016',
'prodaddta_f069016t',
'prodaddta_f07354',
'prodaddta_f07901',
'prodaddta_f07940',
'prodaddta_f08505',
'prodaddta_f03b14',
'prodaddta_f0901',
'prodaddta_f0902',
'prodaddta_f0907',
'prodaddta_f0411z3',
'prodaddta_f0911r',
'prodaddta_f0911r1',
'prodaddta_f0911p',
'prodaddta_f0911z1',
'prodaddta_f0912a',
'prodaddta_f0912b',
'prodaddta_f092181',
'prodaddta_f09ui004',
'prodaddta_f12851',
'prodaddta_f12852',
'prodaddta_f12853',
'prodaddta_f12854',
'prodaddta_f1401',
'prodaddta_f3002',
'prodaddta_f3009',
'prodaddta_f3009t',
'prodaddta_f4006',
'prodaddta_f40070',
'prodaddta_f40072',
'prodaddta_f40073',
'prodaddta_f4008',
'prodaddta_f4009t',
'prodaddta_f4013',
'prodaddta_f4016',
'prodaddta_f4021w',
'prodaddta_f40306',
'prodaddta_f40314',
'prodaddta_f40316',
'prodaddta_f4070',
'prodaddta_f4071',
'prodaddta_f4072',
'prodaddta_f4073',
'prodaddta_f4074',
'prodaddta_f4076',
'prodaddta_f4092',
'prodaddta_f4093',
'prodaddta_f4094',
'prodaddta_f4095',
'prodaddta_f4096',
'prodaddta_f40ui74',
'prodaddta_f4100',
'prodaddta_f41001',
'prodaddta_f41001t',
'prodaddta_f41002',
'prodaddta_f4100t',
'prodaddta_f4101',
'prodaddta_f41015',
'prodaddta_f4101a',
'prodaddta_f4101c',
'prodaddta_f4101g',
'prodaddta_f4101m',
'prodaddta_f4101p',
'prodaddta_f4101t',
'prodaddta_f0911t',
'prodaddta_f0911',
'prodadctl_f98840',
'prodadctl_f98880',
'prodadctl_f98890',
'prodaddta_f0006',
'prodaddta_f0007',
'prodaddta_f0008b',
'prodaddta_f00090',
'prodaddta_f00091',
'prodaddta_f00092',
'prodaddta_f0010',
'prodaddta_f0013',
'prodaddta_f0014',
'prodaddta_f00142',
'prodaddta_f00143',
'prodaddta_f0015',
'prodaddta_f0018',
'prodaddta_f0018t',
'prodaddta_f0030',
'prodaddta_f0041z1',
'prodaddta_f00925',
'prodaddta_f0101',
'prodaddta_f0111',
'prodaddta_f01111',
'prodaddta_f01112',
'prodaddta_f01131m',
'prodaddta_f0116',
'prodaddta_f0117',
'prodaddta_f0150',
'prodaddta_f0301',
'prodaddta_f03012',
'prodaddta_f0311',
'histaddta_f574211',
'prodadctl_f0009',
'prodadctl_f0022',
'prodadctl_f0025',
'prodadctl_f0070',
'prodadctl_f03b26',
'prodadctl_f03b28',
'prodadctl_f03b30',
'prodadctl_f0415',
'prodadctl_f0417',
'prodadctl_f0909',
'prodadctl_f09218',
'prodadctl_f1603',
'prodadctl_f1609',
'prodadctl_f1620',
'prodadctl_f4009',
'prodadctl_f4017',
'prodadctl_f40203',
'prodadctl_f40205',
'prodadctl_f5900101',
'prodadctl_f9000',
'prodadctl_f9001',
'prodadctl_f9005',
'prodadctl_f9006',
'prodadctl_f9010',
'prodadctl_f9030',
'prodadctl_f98800',
'prodadctl_f98800d',
'prodadctl_f98800t',
'prodadctl_f98810',
'histadctl_f00021',
'histaddta_f00950',
'histaddta_f0911t',
'histaddta_f4201',
'histaddta_f4074',
'histaddta_f4220',
'histaddta_f4301',
'histaddta_f4311',
'histaddta_f4311t',
'histaddta_f0911',
'histaddta_f43121',
'histaddta_f5600907',
'histaddta_f5600908',
'histaddta_f5600909',
'histaddta_f5600910',
'histaddta_f5600911',
'histaddta_f5600912',
'histaddta_f5600913',
'histaddta_f5600914',
'histaddta_f5600915',
'histaddta_f5600916',
'histaddta_f5600917',
'histaddta_f5600918',
'histaddta_f5600921',
'histaddta_f5600922',
'histaddta_f5600923',
'histaddta_f5600924',
'histaddta_f4211',
'histaddta_f5600901',
'histaddta_f5705401',
'histaddta_f574201',
'histaddta_f56c091t',
'histaddta_f574301',
'outln_ol$',
'outln_ol$hints',
'outln_ol$nodes',
'prodadctl_f00021',
'prodadctl_f0004',
'prodadctl_f0008';















CREATE DEFINER=`gra`@`%` PROCEDURE `ALTERING_TABLES_ADD_COLUMN_PROC`()
BEGIN




DECLARE COUNTER INT ;
DECLARE TABLE_IDS BIGINT;
DECLARE DIFF INT;
DECLARE COLUMN_NUM_IN_FINAL INT DEFAULT 0 ;
DECLARE COLUMN_NUM_IN_VIEWBOX INT  DEFAULT 0;
DECLARE COLUMN_NAMES_IN_FINAL VARCHAR(60);
DECLARE COLUMN_NAMES_IN_VIEWBOX VARCHAR(60);
DECLARE COLUM_NAMES_TABLE_ROW_COUNT BIGINT;
DECLARE COLUMN_NAMES_IN_THE_FINAL VARCHAR(60);
DECLARE COLUMN_NAMES_IN_THE_VIEWBOX VARCHAR(60);
DECLARE TABLE_NAME_WITH_SCHEMA VARCHAR(60);
DECLARE MISSING_COLUMNS_ROW_NO_ INT DEFAULT 0;


DECLARE CURRENT_TABLE_NAME VARCHAR(300);
DECLARE CURRENT_TABLE_TABLE_COUNTER INT DEFAULT 0;
DECLARE CURRENT_TABLE_TABLE_ROW_NO_ INT DEFAULT 0;





SET COUNTER=1;
SET CURRENT_TABLE_TABLE_COUNTER=1;
SET CURRENT_TABLE_TABLE_ROW_NO_=(SELECT COUNT(*) FROM actebis_jde_dynamic.MODIIES_TABLES);



DROP TABLE if exists actebis_jde_dynamic.LOG;
create table actebis_jde_dynamic.LOG
(

		TABLE_NAMES VARCHAR(300),
        VAR			INT,
        VAR2		INT,
        VAR3		INT
);




	WHILE( CURRENT_TABLE_TABLE_ROW_NO_>=CURRENT_TABLE_TABLE_COUNTER)DO
        
        SET CURRENT_TABLE_NAME=(SELECT TABLES_NAMES FROM actebis_jde_dynamic.MODIIES_TABLES WHERE _ROW_NO_=CURRENT_TABLE_TABLE_COUNTER);
        
        SET TABLE_IDS=(SELECT id from viewbox_merged.tables where name =CURRENT_TABLE_NAME );
        
        DROP TABLE IF exists actebis_jde_dynamic.COLUMN_NAMES_IN_VIEWBOX;
		CREATE TABLE actebis_jde_dynamic.COLUMN_NAMES_IN_VIEWBOX
		(
		NAM VARCHAR(30),
        _ROW_NO_ BIGINT AUTO_INCREMENT PRIMARY KEY
		);




		DROP TABLE IF exists actebis_jde_dynamic.COLUMN_NAMES;
		CREATE TABLE actebis_jde_dynamic.COLUMN_NAMES
		(
		NAM VARCHAR(30),
        _ROW_NO_ BIGINT AUTO_INCREMENT PRIMARY KEY
		);

       
        
        
        INSERT INTO actebis_jde_dynamic.COLUMN_NAMES_IN_VIEWBOX(NAM)
		SELECT name FROM VIEWBOX_MERGED.COLUMNS WHERE TABLE_ID=TABLE_IDS;
        
        INSERT  INTO actebis_jde_dynamic.COLUMN_NAMES(NAM)
		SELECT COLUMN_NAME FROM information_schema.COLUMNS WHERE TABLE_NAME=CURRENT_TABLE_NAME AND  TABLE_SCHEMA='actebis_jde' and column_name!='_row_no_';
        
        
        
			
		DROP TABLE IF exists actebis_jde_dynamic.MISSING_COLUMNS;
		CREATE TABLE actebis_jde_dynamic.MISSING_COLUMNS
		(
		NAM VARCHAR(30),
        _ROW_NO_ BIGINT AUTO_INCREMENT PRIMARY KEY
		);
		
        
        INSERT INTO actebis_jde_dynamic.MISSING_COLUMNS(NAM)
		SELECT B.NAM FROM 
		actebis_jde_dynamic.COLUMN_NAMES A 
		RIGHT JOIN actebis_jde_dynamic.COLUMN_NAMES_IN_VIEWBOX AS B ON A.NAM =B.NAM 
        WHERE A.NAM IS NULL
        ;
        
        
        
		SET COLUMN_NUM_IN_FINAL=(select COUNT(*) from  actebis_jde_dynamic.COLUMN_NAMES);
 
		SET COLUMN_NUM_IN_VIEWBOX=(select COUNT(*) from  actebis_jde_dynamic.COLUMN_NAMES_IN_VIEWBOX);
 
		SET DIFF=(COLUMN_NUM_IN_VIEWBOX-COLUMN_NUM_IN_FINAL);
        
        INSERT INTO actebis_jde_dynamic.LOG VALUES(CURRENT_TABLE_NAME,COLUMN_NUM_IN_FINAL,COLUMN_NUM_IN_VIEWBOX,DIFF);
   
        SET MISSING_COLUMNS_ROW_NO_=(SELECT COUNT(*) FROM actebis_jde_dynamic.MISSING_COLUMNS);
        
        -- IF(DIFF>0)THEN
				
                WHILE(MISSING_COLUMNS_ROW_NO_>=COUNTER)
				DO

		
        
					SET COLUMN_NAMES_IN_THE_VIEWBOX=(SELECT NAM FROM actebis_jde_dynamic.MISSING_COLUMNS WHERE _ROW_NO_=COUNTER );
        
        
       
					set @SQLEX=CONCAT('ALTER TABLE actebis_jde. ',CURRENT_TABLE_NAME ,' ADD COLUMN ', COLUMN_NAMES_IN_THE_VIEWBOX ,' VARCHAR(300) ;');
        
      
       
					PREPARE res_stmt FROM @SQLEX; 
					EXECUTE res_stmt; 
	
					SET COUNTER=COUNTER+1;

				END WHILE;
		-- END IF;
        
        SET CURRENT_TABLE_TABLE_COUNTER=CURRENT_TABLE_TABLE_COUNTER+1;
        
		SET COLUMN_NUM_IN_FINAL=0;
 
		SET COLUMN_NUM_IN_VIEWBOX=0;
 
		SET DIFF=0;
		END WHILE;




DROP TABLE IF exists actebis_jde_dynamic.VARIABLESGRA;
CREATE TABLE actebis_jde_dynamic.VARIABLESGRA
SELECT 
COUNTER,
TABLE_IDS,
DIFF,
COLUMN_NUM_IN_FINAL,
COLUMN_NUM_IN_VIEWBOX,
COLUMN_NAMES_IN_FINAL,
COLUMN_NAMES_IN_VIEWBOX,
COLUM_NAMES_TABLE_ROW_COUNT,
COLUMN_NAMES_IN_THE_VIEWBOX,
CURRENT_TABLE_TABLE_COUNTER,
CURRENT_TABLE_NAME
;


END